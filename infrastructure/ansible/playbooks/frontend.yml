---
- name: Build y Desplegar Frontend a S3
  hosts: localhost
  connection: local
  vars:
    # Calcular rutas basándose en el directorio del playbook
    # playbook_dir es infrastructure/ansible/playbooks
    # Necesitamos ir 3 niveles arriba para llegar a la raíz del proyecto
    project_root: "{{ playbook_dir | dirname | dirname | dirname }}"
    # Usar ruta absoluta calculada, ignorar variable de entorno si es relativa
    terraform_dir: "{{ project_root + '/infrastructure/terraform' }}"
    frontend_dir: "{{ project_root + '/frontend' }}"

  tasks:
    - name: Verificar que terraform-outputs.json existe
      stat:
        path: "{{ terraform_dir }}/terraform-outputs.json"
      register: outputs_file

    - name: Generar terraform-outputs.json si no existe
      command: terraform output -json
      args:
        chdir: "{{ terraform_dir }}"
      register: terraform_outputs
      when: not outputs_file.stat.exists
      changed_when: false

    - name: Guardar outputs en archivo
      copy:
        content: "{{ terraform_outputs.stdout }}"
        dest: "{{ terraform_dir }}/terraform-outputs.json"
      when: not outputs_file.stat.exists

    - name: Leer archivo de outputs
      slurp:
        src: "{{ terraform_dir }}/terraform-outputs.json"
      register: outputs_file_content

    - name: Parsear JSON de outputs
      set_fact:
        terraform_outputs_json: "{{ outputs_file_content.content | b64decode | from_json }}"

    - name: Extraer s3_bucket usando jq (más confiable)
      command: jq -r '.s3_bucket_name.value' "{{ terraform_dir }}/terraform-outputs.json"
      register: s3_bucket_result
      changed_when: false

    - name: Extraer api_gateway_url usando jq
      command: jq -r '.api_gateway_url.value' "{{ terraform_dir }}/terraform-outputs.json"
      register: api_gateway_result
      changed_when: false

    - name: Asignar valores extraídos
      set_fact:
        s3_bucket: "{{ s3_bucket_result.stdout }}"
        api_gateway_url: "{{ api_gateway_result.stdout }}"

    - name: Verificar que npm está instalado
      command: npm --version
      register: npm_check
      changed_when: false
      failed_when: false

    - name: Instalar Node.js y npm si no están instalados
      block:
        - name: Instalar Node.js (Ubuntu/Debian)
          apt:
            name: nodejs npm
            state: present
          when: ansible_os_family == "Debian"
        - name: Instalar Node.js (RedHat/CentOS)
          yum:
            name: nodejs npm
            state: present
          when: ansible_os_family == "RedHat"
      when: npm_check.rc != 0

    - name: Verificar que el directorio frontend existe
      stat:
        path: "{{ frontend_dir }}"
      register: frontend_dir_stat

    - name: Debug - Mostrar rutas calculadas
      debug:
        msg:
          - "playbook_dir: {{ playbook_dir }}"
          - "project_root: {{ project_root }}"
          - "TERRAFORM_DIR env: {{ lookup('env', 'TERRAFORM_DIR') }}"
          - "FRONTEND_DIR env: {{ lookup('env', 'FRONTEND_DIR') }}"
          - "frontend_dir calculado: {{ frontend_dir }}"
          - "frontend_dir existe: {{ frontend_dir_stat.stat.exists }}"

    - name: Crear directorio frontend si no existe
      file:
        path: "{{ frontend_dir }}"
        state: directory
      when: not frontend_dir_stat.stat.exists

    - name: Crear archivo .env.production
      copy:
        content: |
          REACT_APP_API_URL={{ api_gateway_url | regex_replace('/api$', '') }}
        dest: "{{ frontend_dir }}/.env.production"

    - name: Verificar si node_modules existe
      stat:
        path: "{{ frontend_dir }}/node_modules"
      register: node_modules_stat

    - name: Intentar eliminar node_modules (sin sudo)
      file:
        path: "{{ frontend_dir }}/node_modules"
        state: absent
      when: node_modules_stat.stat.exists
      ignore_errors: yes
      register: remove_result

    - name: Advertir si node_modules no se pudo eliminar
      debug:
        msg: |
          ⚠️  ADVERTENCIA: No se pudo eliminar node_modules (probablemente pertenece a root).
          El playbook intentará continuar, pero si falla npm install, ejecuta:
          sudo rm -rf {{ frontend_dir }}/node_modules
      when: node_modules_stat.stat.exists and (remove_result.failed | default(false))

    - name: Instalar dependencias de Node.js (intentará sobrescribir si es necesario)
      command: npm install --force
      args:
        chdir: "{{ frontend_dir }}"
      environment:
        NODE_ENV: production
      become: no
      ignore_errors: yes
      register: npm_install_result

    - name: Fallar con mensaje claro si npm install falló por permisos
      fail:
        msg: |
          ❌ Error: npm install falló por problemas de permisos.
          
          Por favor ejecuta manualmente:
          sudo rm -rf {{ frontend_dir }}/node_modules
          
          Luego vuelve a ejecutar: terraform apply -replace=null_resource.ansible_deploy
      when: npm_install_result.rc != 0 and ("EACCES" in npm_install_result.stderr | default("") or "permission denied" in npm_install_result.stderr | default(""))

    - name: Ejecutar build del frontend
      command: npm run build
      args:
        chdir: "{{ frontend_dir }}"
      environment:
        NODE_ENV: production
        REACT_APP_API_URL: "{{ api_gateway_url }}"

    - name: Verificar que AWS CLI está instalado
      command: aws --version
      register: aws_check
      changed_when: false
      failed_when: false

    - name: Instalar AWS CLI si no está instalado
      block:
        - name: Instalar AWS CLI (pip)
          pip:
            name: awscli
            state: present
      when: aws_check.rc != 0

    - name: Sincronizar build con S3
      command: >
        aws s3 sync {{ frontend_dir }}/build/
        s3://{{ s3_bucket }}/
        --delete
        --region us-east-1

    - name: Mostrar URL del frontend
      debug:
        msg: |
          Frontend desplegado exitosamente!
          URL: http://{{ s3_bucket }}.s3-website-us-east-1.amazonaws.com
          API Gateway: {{ api_gateway_url }}

